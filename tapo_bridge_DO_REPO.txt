\begin{lstlisting}[language=Python, caption={Skrypt mostkujący (bridge) translatora MQTT na protokół KLAP dla żarówek Tapo}, label={lst:tapo_bridge}]
import asyncio
import paho.mqtt.client as mqtt
from plugp100.common.credentials import AuthCredential
from plugp100.new.device_factory import connect, DeviceConnectConfiguration

# Konfiguracja polaczenia (dane zredagowane)
BULB_IP = "IP_ADDRESS"
TAPO_USER = "USER_EMAIL"
TAPO_PASS = "USER_PASSWORD"
MQTT_BROKER = "127.0.0.1"
MQTT_TOPIC = "inzynierka/plytka1/bulb"

bulb_device = None

async def setup_bulb():
    global bulb_device
    credentials = AuthCredential(TAPO_USER, TAPO_PASS)
    config = DeviceConnectConfiguration(
        host=BULB_IP,
        credentials=credentials,
        device_type="SMART.TAPOBULB",
        encryption_type="klap",
        encryption_version=2
    )
    try:
        bulb_device = await connect(config)
        await bulb_device.update()
        return True
    except Exception:
        return False

async def toggle(state):
    if not bulb_device:
        return
    try:
        if state == "1":
            await bulb_device.on()
        elif state == "0":
            await bulb_device.off()
    except Exception:
        pass

def on_message(client, userdata, msg):
    payload = msg.payload.decode().strip()
    asyncio.run_coroutine_threadsafe(toggle(payload), loop)

mqtt_client = mqtt.Client(mqtt.CallbackAPIVersion.VERSION1)
mqtt_client.on_message = on_message

async def main():
    global loop
    loop = asyncio.get_running_loop()
    while not await setup_bulb():
        await asyncio.sleep(10)

    mqtt_client.connect(MQTT_BROKER, 1883, 60)
    mqtt_client.subscribe(MQTT_TOPIC)

    while True:
        mqtt_client.loop(0.1)
        await asyncio.sleep(0.1)

if __name__ == "__main__":
    try:
        asyncio.run(main())
    except KeyboardInterrupt:
        pass
\end{lstlisting}